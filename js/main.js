var g_Config={enable_color:!0,mono_color:"#fff",screen_width:80,screen_height:50,pixel_size:8,invader_size:5,invader_simetric_width:2,interinvader_space:2,player_cannon:32512,player_bullet_position_offset:2,player_initial_lives:3,player_lives_reduction:1,player_inter_shoot_turns:10,invasor_kill_score:100,invasor_kills_for_life_extensions:2,initial_invader_cols:7,initial_invader_rows:4,invasion_max_shoots_per_turn:2,invasion_shoot_probability:.1,invasion_inter_movement_turns:1,eplosion_density:.5,explosion_life_turns:2,bullet_color:"#ffff00",explosion_color:"#ff0000"};g_Config.message_font_height=2*g_Config.pixel_size,g_Config.canvas_width=g_Config.screen_width*g_Config.pixel_size,g_Config.canvas_height=g_Config.screen_height*g_Config.pixel_size;var g_keys={left:37,right:39,space:32,letter_r:82,letter_f:70},supports_html5_storage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(n){return!1}};g_Config.has_local_storage=supports_html5_storage();var sound=function(n){var i=new Audio(n);return function(){i.play()}},with_pixelated_screen=function(n,i,e,o,t,r){var f=function(){var n=this,f=[],a=0;i().width=window.innerWidth,i().height=window.innerHeight;var g=Math.floor(i().width/t),c=Math.floor(i().height/r);for(n.pixel_width=function(){return g},n.pixel_height=function(){return c},e().font=1.5*c+"px game-font",a=0;t>a;a++)f[a]=[];var l=function(n,i){var e=n>=0&&t>n,o=i>=0&&r>i;return e&&o};n.clear=function(){for(o(),a=0;t>a;a++)f[a]=[];s={},u=0,d={},v=0},n.put_pixel=function(){return g_Config.enable_color?function(n,i,o){l(n,i)&&(e().fillStyle=o,e().fillRect(n*g,i*c,g,c),f[n][i]=o)}:function(n,i){var o="#fff";l(n,i)&&(e().fillStyle=o,e().fillRect(n*g,i*c,g,c),f[n][i]=o)}}(),n.get_pixel=function(n,i){return l(n,i)?f[n][i]:void console.log("Error")};var s={},u=0,h=function(n,i,o){this.text=n,this.row=o,this.col=i,this.id=u,u+=1,this.draw=function(){e().fillStyle="#fff",e().fillText(n,i*g,o*c)}};n.write_text_at=function(n,i,e){var o=new h(n,i,e);s[o.id.toString()]=o,o.draw()},n.go_full_screen=function(){i().requestFullScreen?i().requestFullScreen():i().webkitRequestFullScreen?i().webkitRequestFullScreen():i().mozRequestFullScreen&&i().mozRequestFullScreen()};var d={},v=0,w=function(n,i,o){this.id=v,v+=1,this.draw=function(){var t=3*g;e().beginPath(),e().fillStyle=o,e().arc(n*g,i*c,t,0,2*Math.PI,!1),e().fill(),e().closePath()}};this.create_button=function(n,i,e){var o=new w(n,i,e);d[o.id.toString()]=o,o.draw()},n.redraw=function(){i().width=window.innerWidth,i().height=window.innerHeight,g=Math.floor(i().width/t),c=Math.floor(i().height/r),e().font=1*c+"px game-font",_.each(s,function(n){n.draw()}),_.each(f,function(n,i){_.each(n,function(n,o){e().fillStyle=n,e().fillRect(i*g,o*c,g,c)})}),_.each(d,function(n){n.draw()})},n.width=function(){return t},n.height=function(){return r},n.drawing_context=e};pixelated_screen=new f,window.addEventListener("resize",pixelated_screen.redraw,!1),window.go_full_screen=pixelated_screen.go_full_screen,n(pixelated_screen)};with_simetric_invaders=function(n,i){var e=_.memoize(function(n){for(var i=n.toString(2);-1===i.indexOf("1")||-1===i.indexOf("0");)i=Math.floor(100*Math.random()).toString(2);return i}),o=_.memoize(function(){for(var n=_.sample(["f0","f0","f0","00","00","00"],3),i="#"+n.join("");-1===i.indexOf("f")||-1===i.indexOf("0");)n=_.sample(["f0","f0","f0","00","00","00"],3),i="#"+n.join("");return i}),t=function(n,t,r){var _=0,f=0,a=e(n),g=g_Config.invader_size-g_Config.invader_simetric_width;for(g*=g_Config.invader_size,_=0;g>_;_++)if(f=a[a.length-1-_%a.length],"1"===f){var c,l=_%(g_Config.invader_size-g_Config.invader_simetric_width),s=Math.floor(_/(g_Config.invader_size-g_Config.invader_simetric_width)),u=g_Config.invader_size-l-1;c=g_Config.enable_color?o(n):g_Config.mono_color,i(t+l,r+s,c),i(t+u,r+s,c)}};n(t)};var with_key_bindings=function(n){var i={},e=function(n,e){i[n.toString()]=e},o=function(){i={},$(document.body).unbind("keydown"),$(document.body).keydown(function(n){var e=n.keyCode.toString();i[e]&&i[e]()})};o(),n(e,o)},with_bullets=function(n,i,e){var o={},t=0,r=function(n,e){var o=this;o.id=t,t+=1,o.age=0,o.draw=function(){o.age+=1;var t,r;for(t=n+1;t<n+1+g_Config.invader_size-1;t++)for(r=e+1;r<e+1+g_Config.invader_size-1;r++){var _=Math.random();_>g_Config.eplosion_density&&i(t,r,g_Config.explosion_color)}}},f=function(n,i){var e=new r(n,i);o[t.toString()]=e},a=function(){o={},t=0},g={},c=0,l=function(n,i,e){this.x=n,this.y=i,this.id=c,this.velocity=e,c+=1},s=function(n,i){var e=new l(n,i,-1);g[e.id.toString()]=e},u=function(n,i){var e=new l(n,i,1);g[e.id.toString()]=e},h=function(){g=[],c=0},d=0,v={},w=function(){v={},d=0},C=function(n,i,e){var o=d.toString();v[o]={x:n,y:i,callback:e,id:o},d++},p=function(n,i){return n.x>=i.x&&n.x<i.x+g_Config.invader_size&&n.y>=i.y&&n.y<i.y+g_Config.invader_size&&e(n.x,n.y)?!0:!1},x=function(){_.each(g,function(n){n.y<0||n.y>g_Config.screen_height?delete c[n.id.toString()]:(n.y+=n.velocity,_.any(v,function(i){return p(n,i)?(f(i.x,i.y),i.callback(),delete v[i.id],delete g[n.id],!0):!1})||i(n.x,n.y,g_Config.bullet_color))}),_.each(o,function(n){n.age>g_Config.explosion_life_turns?delete o[n.id.toString()]:n.draw()})};n(x,s,u,w,C,h,a)},with_invasion=function(n,i,e,o,t){var r=0,f=g_Config.interinvader_space+g_Config.invader_size,a="left",g=g_Config.initial_invader_cols,c=g_Config.initial_invader_rows,l=c*g,s=g_Config.invader_size+g_Config.interinvader_space,u=0,h=[],d=function(){var n=h.slice(0);return h=[],[n]},v=[],w=function(){var n=0,i=0;for(i=0;c>i;i++)for(v[i]=[],n=0;g>n;n++)v[i][n]=n;r=0,f=g_Config.interinvader_space+g_Config.invader_size,a="left",l=c*g,u+=l},C=function(){var n=sound("art/sound/explosion.wav");return function(i,e){v[i][e]=-1,h.push("invasor_killed"),n(),l-=1}}(),p=function(n,i){return-1!=v[n][i]},x=function(){var n,e,_,a=function(n,i){return function(){C(n,i)}};for(o(),row=0;c>row;row++)for(col=0;g>col;col++)if(p(row,col)){if(n=r+col*s,e=f+row*s,e+g_Config.invader_size>g_Config.screen_height-g_Config.interinvader_space-3){h.push("game_over");break}_=u+row*g+col,t(n,e,a(row,col)),i(_,n,e)}},y=function(){var n=[];for(row=0;c>row;row++)for(col=0;g>col;col++)if(p(row,col)){n.push(col);break}return _.min(n)},m=function(){var n=[];for(row=0;c>row;row++)for(col=g-1;col>=0;col--)if(p(row,col)){n.push(col);break}return _.max(n)+1},b=function(){var n=[];for(col=0;g>col;col++)for(row=c-1;row>=0;row--)if(p(row,col)){n.push({row:row,col:col});break}return n},S=function(){var n=b();if(n.length>0){var i=_.sample(n);e(r+i.col*s+g_Config.invader_simetric_width+1,f+g_Config.invader_size+i.row*s)}},k=function(){"left"===a?r>0-y()*s?r-=1:(a="right",f++):r<g_Config.screen_width-m()*s?r+=1:(a="left",f++)},z=0,M=function(){0===z?(k(),z=g_Config.invasion_inter_movement_turns):z--;var n=0,i=0,e=0;for(n=0;n<g_Config.initial_invader_cols&&(e=Math.random(),e<g_Config.invasion_shoot_probability&&(i++,S()),!(i>=g_Config.invasion_max_shoots_per_turn));n++);0===l&&h.push("invasion_wave_cleared")};n(w,x,M,d)},with_player_cannon=function(n,i,e,o){var t=Math.floor(g_Config.screen_width/2),r=g_Config.screen_height-g_Config.interinvader_space-g_Config.invader_size,_=g_Config.player_initial_lives,f=[],a=function(){t=Math.floor(g_Config.screen_width/2),r=g_Config.screen_height-g_Config.interinvader_space-g_Config.invader_size},g=function(){_=g_Config.player_initial_lives},c=function(){var n=f.slice(0);return f=[],[n]},l=function(){var n=sound("art/sound/player-explosion.wav");return function(){_-=g_Config.player_lives_reduction,n(),f.push(0>_?"game_over":"player_loses_one_life")}}(),s=function(){var n=sound("art/sound/life-extension.wav");return function(){_+=g_Config.player_lives_reduction,n()}}(),u=function(){return _},h=function(){t>0&&(t-=1)},d=function(){t<g_Config.screen_width-g_Config.invader_size&&(t+=1)},v=0,w=function(){i(g_Config.player_cannon,t,r),o(t,r,l),v>0&&v--},C=function(){var n=sound("art/sound/phaser.wav");return function(){0===v&&(n(),e(t+g_Config.player_bullet_position_offset,r+2),v=g_Config.player_inter_shoot_turns)}}(),p={fire:C,move_left:h,move_right:d};n(w,p,u,a,g,c,s)},with_ui=function(n,i,e,o,t,r){var f=0,a=1,g=1,c=function(){f=0,a=0},l={},s=0,u=function(n,e,o,t){var r=this;r.id=s,s++,r.draw=function(){i.create_button(n,e,o)},r.contains=function(o,r){var _=Math.floor(o/i.pixel_width()),f=Math.floor(r/i.pixel_height());console.log("pxl "+o+" "+r),console.log("clk "+_+" "+f),console.log("btn "+n+" "+e);var a=Math.abs(_-n)<5,g=Math.abs(f-e)<5;return a&&g&&t(),a&&g}};$("body").on("mousedown",function(n){_.any(l,function(i){i.contains(n.offsetX,n.offsetY)})});var h=function(n,i,e,o){var t=new u(n,i,e,o);l[t.id.toString()]=t},d=function(){l={},s=0},v=function(){d(),h(Math.floor(1*i.width()/16),Math.floor(15*i.height()/16),"#ff0000",r.move_left),h(Math.floor(3*i.width()/16),Math.floor(15*i.height()/16),"#00ff00",r.move_right),h(Math.floor(15*i.width()/16),Math.floor(15*i.height()/16),"#0000ff",r.fire)},w=function(){var n=0;for(n=0;n<o();n++)e(g_Config.player_cannon,g_Config.interinvader_space+n*(g_Config.invader_size+g_Config.interinvader_space),0);i.write_text_at("Score",g_Config.screen_width/2,3),i.write_text_at(f,g_Config.screen_width/2,3+g_Config.message_font_height/g_Config.pixel_size),i.write_text_at("Wave",g_Config.screen_width/4*3,3),i.write_text_at(a,g_Config.screen_width/4*3,3+g_Config.message_font_height/g_Config.pixel_size),_.each(l,function(n){n.draw()})},C=function(n){f+=n;var i=Math.pow(g_Config.invasor_kills_for_life_extensions,g)*g_Config.invasor_kill_score;f>i-1&&i+1>f&&(o()<g_Config.player_initial_lives&&t(),g+=1)},p=function(){a+=1},x=function(){d(),h(Math.floor(1*i.width()/16),Math.floor(15*i.height()/16),"#ff0000",function(){var n=jQuery.Event("keydown",{keyCode:g_keys.letter_r});$(document.body).trigger(n)}),h(Math.floor(3*i.width()/16),Math.floor(15*i.height()/16),"#00ff00",window.go_full_screen)},y=function(n){if(i.clear(),i.write_text_at(n,g_Config.screen_width/4,g_Config.screen_height/2),i.write_text_at("Final Score: "+f,g_Config.screen_width/4,g_Config.screen_height/2+g_Config.message_font_height/g_Config.pixel_size),i.write_text_at("Final Wave: "+a,g_Config.screen_width/4,g_Config.screen_height/2+2*g_Config.message_font_height/g_Config.pixel_size),g_Config.has_local_storage){var e=window.localStorage.getItem("max_score");null!==e?f>e&&window.localStorage.setItem("max_score",f):window.localStorage.setItem("max_score",f)}},m=function(){i.clear();var n=["***......................................................",".*....................................*..................",".*.......................................................",".*...*.***...*...*...****....****....**.....****...*.***.",".*...**...*..*...*.......*..*....*....*....*....*..**...*",".*...*....*..*...*...*****...**.......*....*....*..*....*",".*...*....*...*.*...*....*.....**.....*....*....*..*....*",".*...*....*...*.*...*...**..*....*....*....*....*..*....*","***..*....*....*.....***.*...****...*****...****...*....*"],e=Math.floor((i.width()-n[0].length)/2),o=20;if(_.each(n,function(n){var t=e;_.each(n,function(n){"*"===n&&i.put_pixel(t,o,"#fff"),t+=1}),o+=1}),i.write_text_at("The game everyone should be talking about!",g_Config.screen_width/4,g_Config.screen_height/4*3),i.write_text_at("Press 'r' to start the game.",g_Config.screen_width/4,g_Config.screen_height/4*3+2),g_Config.has_local_storage){var t=window.localStorage.getItem("max_score");null!==t?i.write_text_at("Your max Score: "+t,g_Config.screen_width/4,g_Config.screen_height/4*3+4):console.log("No recorded max score")}x(),_.each(l,function(n){n.draw()})};n(w,C,c,y,p,m,v)};with_game_canvas(function(n,i,e){with_pixelated_screen(function(n){with_simetric_invaders(function(i){with_bullets(function(e,o,t,r,f,a,g){with_invasion(function(t,r,c,l){with_player_cannon(function(o,f,s,u,h,d,v){with_ui(function(i,s,v,w,C,p,x){with_key_bindings(function(y,m){with_loop(100,function(t,f,a,g){n.clear(),r(),o(),c(),e(),i(),_.each(d(),function(n){t[n]&&t[n](f,a,g)}),_.each(l(),function(n){t[n]&&t[n](f,a,g)})},function(i){a(),u(),g(),n.clear(),p(),m(),y(g_keys.left,f.move_left),y(g_keys.right,f.move_right),y(g_keys.space,f.fire),y(g_keys.letter_f,go_full_screen),y(g_keys.letter_r,function(){console.log("Starting"),h(),v(),t(),x(),i()})},{player_loses_one_life:function(){a(),u()},game_over:function(n,i,e){i(),$(document.body).unbind("keydown"),w("Game over!"),window.setTimeout(e,2e3)},invasor_killed:function(){s(g_Config.invasor_kill_score)},invasion_wave_cleared:function(){C(),a(),t()}})})},n,i,s,v,f)},i,o,f)},i,t,r,f)},n.put_pixel,n.get_pixel)},n.put_pixel)},e,i,n,g_Config.screen_width,g_Config.screen_height)});